<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <!-- 使用 bin 目錄下的 tasks 路徑 -->
    <DirectoryTreeGeneratorTaskDir>$(TargetFramework)</DirectoryTreeGeneratorTaskDir>

    <!-- 設定 Task 組件路徑 -->
    <DirectoryTreeGeneratorTaskPath>$(MSBuildThisFileDirectory)..\bin\Debug\$(DirectoryTreeGeneratorTaskDir)\tasks\DirectoryTreeGenerator.dll</DirectoryTreeGeneratorTaskPath>
  </PropertyGroup>

  <!-- 註冊 Task -->
  <UsingTask TaskName="ozakboy.DirectoryTreeGenerator.MSBuild.GenerateDirectoryTreeTask"
             AssemblyFile="$(DirectoryTreeGeneratorTaskPath)" />

  <!-- 配置預設值 -->
  <PropertyGroup>
    <GenerateDirectoryTree Condition="'$(GenerateDirectoryTree)' == ''">true</GenerateDirectoryTree>
    <DirectoryTreeConfigPath Condition="'$(DirectoryTreeConfigPath)' == ''">$(MSBuildProjectDirectory)\directorytree.json</DirectoryTreeConfigPath>
  </PropertyGroup>

  <!-- 診斷資訊 -->
  <Target Name="DirectoryTreeGeneratorDiagnostics" BeforeTargets="GenerateDirectoryTreeAfterBuild">
    <Message Text="DirectoryTreeGenerator 診斷資訊:" Importance="high" />
    <Message Text="目標框架: $(TargetFramework)" Importance="high" />
    <Message Text="選擇的 Task 框架: $(DirectoryTreeGeneratorTaskDir)" Importance="high" />
    <Message Text="Task 路徑: $(DirectoryTreeGeneratorTaskPath)" Importance="high" />
    <Message Text="專案目錄: $(MSBuildProjectDirectory)" Importance="high" />
    <Message Text="配置檔案: $(DirectoryTreeConfigPath)" Importance="high" />
  </Target>

  <!-- 生成目錄樹 -->
  <Target Name="GenerateDirectoryTreeAfterBuild"
          AfterTargets="Build"
          Condition="'$(GenerateDirectoryTree)' == 'true'">

    <Warning Text="找不到對應框架的 DirectoryTreeGenerator 組件: $(DirectoryTreeGeneratorTaskPath)"
             Condition="!Exists('$(DirectoryTreeGeneratorTaskPath)')" />

    <GenerateDirectoryTreeTask
        ProjectDir="$(MSBuildProjectDirectory)"
        ConfigPath="$(DirectoryTreeConfigPath)"
        Condition="Exists('$(DirectoryTreeGeneratorTaskPath)')" />
  </Target>
</Project>