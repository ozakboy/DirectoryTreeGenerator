<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <!-- 使用相對路徑而不是固定路徑 -->
    <DirectoryTreeGeneratorTaskDir>$(MSBuildThisFileDirectory)..\tasks</DirectoryTreeGeneratorTaskDir>
    <DirectoryTreeGeneratorTaskPath>$(DirectoryTreeGeneratorTaskDir)\DirectoryTreeGenerator.dll</DirectoryTreeGeneratorTaskPath>
  </PropertyGroup>

  <!-- 註冊 Task -->
  <UsingTask TaskName="ozakboy.DirectoryTreeGenerator.MSBuild.GenerateDirectoryTreeTask"
             AssemblyFile="$(DirectoryTreeGeneratorTaskPath)" />

  <!-- 配置預設值 -->
  <PropertyGroup>
    <GenerateDirectoryTree Condition="'$(GenerateDirectoryTree)' == ''">true</GenerateDirectoryTree>
    <DirectoryTreeConfigPath Condition="'$(DirectoryTreeConfigPath)' == ''">$(MSBuildProjectDirectory)\directorytree.json</DirectoryTreeConfigPath>
  </PropertyGroup>

  <!-- 在建置之前執行的診斷資訊 -->
  <Target Name="DirectoryTreeGeneratorDiagnostics" BeforeTargets="GenerateDirectoryTreeAfterBuild">
    <Message Text="DirectoryTreeGenerator 診斷資訊:" Importance="high" />
    <Message Text="Task 路徑: $(DirectoryTreeGeneratorTaskPath)" Importance="high" />
    <Message Text="專案目錄: $(MSBuildProjectDirectory)" Importance="high" />
    <Message Text="配置檔案: $(DirectoryTreeConfigPath)" Importance="high" />
  </Target>

  <!-- 生成目錄樹 -->
  <Target Name="GenerateDirectoryTreeAfterBuild"
          AfterTargets="Build"
          Condition="'$(GenerateDirectoryTree)' == 'true'">

    <Warning Text="找不到對應框架的 DirectoryTreeGenerator 組件: $(DirectoryTreeGeneratorTaskPath)"
             Condition="!Exists('$(DirectoryTreeGeneratorTaskPath)')" />

    <GenerateDirectoryTreeTask
       ProjectDir="$(MSBuildProjectDirectory)"
       ConfigPath="$(DirectoryTreeConfigPath)"
       Condition="Exists('$(DirectoryTreeGeneratorTaskPath)')"
       ContinueOnError="true" />
  </Target>
</Project>